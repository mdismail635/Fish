<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>মাছের দর হিসাব</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 8px;
            background-color: #f5f5f5;
            font-size: 13px;
            touch-action: manipulation;
        }
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .underline {
            border-bottom: 1px solid #000;
            margin: 3px 0;
            display: inline-block;
            min-width: 100px;
            padding-bottom: 2px;
        }
        .zoom-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 5px 0;
        }
        .zoom-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #ddd;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 5px 3px;
            text-align: center;
            word-wrap: break-word;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            font-size: 12px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .input-cell {
            width: 100%;
            padding: 3px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 2px;
            box-sizing: border-box;
            font-size: 12px;
        }
        .total-row {
            font-weight: bold;
            background-color: #e6f7ff;
        }
        .serial {
            width: 30px;
        }
        .fish-name {
            width: 50px;
        }
        .maund-rate {
            width: 80px;
        }
        .rate {
            width: 50px;
        }
        .kg {
            width: 50px;
        }
        .amount {
            width: 70px;
            min-width: 70px;
        }
        .wholesaler {
            width: 90px;
        }
        .wholesale-total {
            width: 80px;
            font-weight: bold;
        }
        .sum-cell {
            background-color: #fffacd;
            font-weight: bold;
        }
        .first-occurrence {
            background-color: #ffffcc;
        }
        .total-row-highlight {
            background-color: #ffeb99;
            font-weight: bold;
        }
        .empty-cell {
            color: transparent;
        }
        .page-controls {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        .page-btn {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .page-info {
            font-weight: bold;
            padding: 5px 10px;
        }
        .page-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .page-tab {
            padding: 5px 10px;
            background-color: #ddd;
            border-radius: 3px;
            cursor: pointer;
        }
        .page-tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .wholesaler-summary-row {
            background-color: #f0fff0;
        }
        .backup-controls {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        .backup-btn {
            padding: 5px 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            display: none;
        }
        .install-btn {
            padding: 5px 10px;
            background-color: #FF9800;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px 0;
            display: none;
        }
        @media (max-width: 400px) {
            th, td {
                padding: 4px 2px;
                font-size: 11px;
            }
            .fish-name {
                width: 60px;
            }
            .maund-rate {
                width: 70px;
            }
            .rate, .kg {
                width: 40px;
            }
            .amount {
                width: 50px;
            }
            .wholesaler {
                width: 70px;
            }
            .wholesale-total {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="confirmation" id="confirmation"></div>
    
    <button id="installButton" class="install-btn" onclick="installPWA()">অ্যাপ ইন্সটল করুন</button>
    
    <div class="header">
        <div>পার্টি নাম: <span class="underline" id="partyName" contenteditable="true">&nbsp;</span></div>
        <div>তারিখ: <span class="underline" id="dateField" contenteditable="true">&nbsp;</span></div>
    </div>

    <div class="page-tabs" id="pageTabs"></div>

    <div class="page-controls">
        <button class="page-btn" onclick="addNewPage()">নতুন পেজ (+)</button>
        <div class="page-info">পেজ: <span id="currentPage">1</span></div>
        <div>
            <button class="page-btn" onclick="prevPage()">পূর্ববর্তী</button>
            <button class="page-btn" onclick="nextPage()">পরবর্তী</button>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">জুম আউট (-)</button>
        <button class="zoom-btn" onclick="zoomIn()">জুম ইন (+)</button>
    </div>

    <div class="table-container" id="tableContainer">
        <table id="fishTable">
            <thead>
                <tr>
                    <th class="serial">ক্রমিক</th>
                    <th class="fish-name">মাছের নাম</th>
                    <th class="maund-rate">মন দর</th>
                    <th class="rate">দর</th>
                    <th class="kg">কেজি</th>
                    <th class="amount">টাকা</th>
                    <th class="wholesaler">পাইকার নাম</th>
                    <th class="wholesale-total">পাইকার মোট</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Rows will be added automatically by JavaScript -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5" style="text-align: right;">মোট টাকা =</td>
                    <td id="totalTk" class="sum-cell">0</td>
                    <td colspan="2"></td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">পেজ মোট</td>
                    <td id="totalKg">0</td>
                    <td id="sumTk">0</td>
                    <td colspan="2" id="totalWholesale" class="sum-cell">0</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">সর্বমোট (সকল পেজ)</td>
                    <td id="grandTotalKg">0</td>
                    <td id="grandSumTk">0</td>
                    <td colspan="2" id="grandTotalWholesale" class="sum-cell">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="backup-controls">
        <button class="backup-btn" onclick="backupData()">ডেটা সেভ করুন</button>
        <button class="backup-btn" onclick="restoreData()">ডেটা রিস্টোর করুন</button>
        <button class="backup-btn" onclick="exportData()">ডেটা ডাউনলোড করুন</button>
        <button class="backup-btn" onclick="importData()">ডেটা আপলোড করুন</button>
        <button class="backup-btn" onclick="signInWithGoogle()">গুগল ড্রাইভে সেভ করুন</button>
        <button class="backup-btn" onclick="loadFromGoogleDrive()">গুগল ড্রাইভ থেকে লোড করুন</button>
    </div>

    <script>
        // Google Drive API configuration
        const CLIENT_ID = '716394900797-snmc10jkgi23p57pd7405i94et5i8ks5.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBUUxEsQCdz2ACBZvb2m5uR-P6OdhfoYAs';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // Application state
        let currentZoom = 100;
        const WHOLESALER_RATE = 1.03;
        let pages = [];
        let currentPageIndex = 0;
        const ROWS_PER_PAGE = 60;
        let currentDate = '';
        let allWholesalers = {};
        const WHOLESALER_SUMMARY_START_ROW = 1;
        let deferredPrompt = null;
        
        // Unique storage key
        const STORAGE_KEY = 'fish_calculator_data_v3';
        
        // Initialize Google API client
        function initGoogleClient() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                }).then(() => {
                    console.log('Google API client initialized');
                }, (error) => {
                    console.error('Error initializing Google API client', error);
                });
            });
        }
        
        // Load Google API script
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                initGoogleClient();
            };
            document.body.appendChild(script);
        }
        
        // Sign in with Google
        function signInWithGoogle() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                showConfirmation('গুগলে সাইন ইন সফল হয়েছে!');
                uploadToGoogleDrive();
            }).catch(error => {
                showConfirmation('সাইন ইন করতে সমস্যা হয়েছে: ' + error.error);
            });
        }
        
        // Upload to Google Drive
        function uploadToGoogleDrive() {
            const data = prepareBackupData();
            const date = new Date().toISOString().split('T')[0];
            const fileName = `fish_calculator_${date}.json`;
            
            const fileContent = JSON.stringify(data, null, 2);
            const file = new Blob([fileContent], {type: 'application/json'});
            const metadata = {
                'name': fileName,
                'mimeType': 'application/json'
            };
            
            const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            }).then((response) => {
                return response.json();
            }).then((data) => {
                showConfirmation('গুগল ড্রাইভে সফলভাবে সেভ করা হয়েছে!');
                console.log('File uploaded:', data);
            }).catch((error) => {
                showConfirmation('আপলোড করতে সমস্যা হয়েছে: ' + error.message);
                console.error('Upload error:', error);
            });
        }
        
        // Load from Google Drive
        function loadFromGoogleDrive() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                gapi.client.drive.files.list({
                    'pageSize': 10,
                    'fields': "files(id, name)",
                    'q': "name contains 'fish_calculator' and mimeType='application/json'",
                    'orderBy': 'modifiedTime desc'
                }).then((response) => {
                    const files = response.result.files;
                    if (files.length === 0) {
                        showConfirmation('কোন ফাইল পাওয়া যায়নি!');
                        return;
                    }
                    
                    // For simplicity, just load the most recent file
                    const fileId = files[0].id;
                    downloadFromGoogleDrive(fileId);
                });
            }).catch(error => {
                showConfirmation('সাইন ইন করতে সমস্যা হয়েছে: ' + error.error);
            });
        }
        
        // Download from Google Drive
        function downloadFromGoogleDrive(fileId) {
            gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            }).then((response) => {
                if (confirm('আপনি কি নিশ্চিত যে আপনি বর্তমান ডেটা প্রতিস্থাপন করতে চান? এটি বর্তমান ডেটা মুছে ফেলবে!')) {
                    restoreBackupData(response.result);
                    showConfirmation('গুগল ড্রাইভ থেকে ডেটা সফলভাবে লোড করা হয়েছে!');
                }
            }).catch((error) => {
                showConfirmation('ডেটা লোড করতে সমস্যা হয়েছে: ' + error.message);
                console.error('Download error:', error);
            });
        }
        
        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showConfirmation('অ্যাপ ইন্সটল করা হচ্ছে...');
                    }
                    deferredPrompt = null;
                    document.getElementById('installButton').style.display = 'none';
                });
            }
        }
        
        // Show confirmation message
        function showConfirmation(message) {
            const confirmation = document.getElementById('confirmation');
            confirmation.textContent = message;
            confirmation.style.display = 'block';
            setTimeout(() => {
                confirmation.style.display = 'none';
            }, 3000);
        }
        
        // Prepare backup data
        function prepareBackupData() {
            return {
                pages: pages,
                currentPageIndex: currentPageIndex,
                currentDate: currentDate,
                allWholesalers: allWholesalers,
                partyName: document.getElementById('partyName').textContent.trim()
            };
        }
        
        // Restore backup data
        function restoreBackupData(data) {
            pages = data.pages || [];
            currentPageIndex = data.currentPageIndex || 0;
            currentDate = data.currentDate || '';
            allWholesalers = data.allWholesalers || {};
            
            if (data.partyName) {
                document.getElementById('partyName').textContent = data.partyName;
            }
            
            if (pages.length === 0) {
                addNewPage();
            } else {
                renderPage(currentPageIndex);
                updatePageTabs();
            }
            
            // Auto-save to localStorage
            backupData();
        }
        
        // Save all data to localStorage
        function backupData() {
            const data = prepareBackupData();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            showConfirmation('ডেটা সফলভাবে সেভ করা হয়েছে!');
        }
        
        // Restore data from localStorage
        function restoreData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    restoreBackupData(data);
                } catch (e) {
                    showConfirmation('ডেটা রিস্টোর করতে সমস্যা হয়েছে!');
                    console.error(e);
                }
            } else {
                showConfirmation('কোন সেভ করা ডেটা পাওয়া যায়নি!');
            }
        }
        
        // Export data as JSON file
        function exportData() {
            const data = prepareBackupData();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fish_calculator_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showConfirmation('ডেটা সফলভাবে ডাউনলোড করা হয়েছে!');
        }
        
        // Import data from JSON file
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('আপনি কি নিশ্চিত যে আপনি বর্তমান ডেটা প্রতিস্থাপন করতে চান? এটি বর্তমান ডেটা মুছে ফেলবে!')) {
                            restoreBackupData(data);
                        }
                    } catch (e) {
                        showConfirmation('ফাইল পড়তে সমস্যা হয়েছে! সঠিক ফরম্যাট নয়।');
                        console.error(e);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Auto-save every 30 seconds
        setInterval(backupData, 30000);
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            const today = new Date();
            currentDate = today.getDate() + '/' + (today.getMonth()+1) + '/' + today.getFullYear();
            document.getElementById('dateField').textContent = currentDate;
            
            // Load Google API
            loadGoogleAPI();
            
            // Try to restore saved data
            setTimeout(restoreData, 100);
            
            // Initialize first page if no data was restored
            setTimeout(() => {
                if (pages.length === 0) {
                    addNewPage();
                }
            }, 200);
            
            // Listen for changes to auto-save
            document.getElementById('dateField').addEventListener('input', backupData);
            document.getElementById('partyName').addEventListener('input', backupData);
        });
        
        // Prevent accidental page leave
        window.addEventListener('beforeunload', function(e) {
            // Only prompt if there's actual data
            if (pages.length > 0 && pages[0].rows.some(row => 
                row.fishName || row.maundRate || row.kg || row.wholesalerName)) {
                e.preventDefault();
                e.returnValue = 'আপনার ডেটা সেভ করা হয়নি! আপনি কি নিশ্চিত যে আপনি এই পৃষ্ঠা ছেড়ে যেতে চান?';
            }
        });

        // Original fish calculator functions
        function addNewPage() {
            const newPage = {
                rows: [],
                partyName: '',
                date: currentDate
            };
            
            for (let i = 1; i <= ROWS_PER_PAGE; i++) {
                newPage.rows.push({
                    fishName: '',
                    maundRate: '',
                    kg: '',
                    wholesalerName: '',
                    calculatedRate: 0,
                    calculatedAmount: 0,
                    calculatedWholesaleTotal: 0,
                    isSummaryRow: false
                });
            }
            
            pages.push(newPage);
            currentPageIndex = pages.length - 1;
            updatePageTabs();
            renderPage(currentPageIndex);
            updateAllWholesalers();
            updateWholesalerSummary();
        }
        
        function updatePageTabs() {
            const pageTabs = document.getElementById('pageTabs');
            pageTabs.innerHTML = '';
            
            pages.forEach((page, index) => {
                const tab = document.createElement('div');
                tab.className = `page-tab ${index === currentPageIndex ? 'active' : ''}`;
                tab.textContent = `পেজ ${index + 1}`;
                tab.onclick = () => {
                    currentPageIndex = index;
                    renderPage(currentPageIndex);
                    updatePageTabs();
                };
                pageTabs.appendChild(tab);
            });
        }
        
        function renderPage(pageIndex) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const page = pages[pageIndex];
            document.getElementById('currentPage').textContent = pageIndex + 1;
            
            page.rows.forEach((rowData, i) => {
                const row = document.createElement('tr');
                const rowNumber = (pageIndex * ROWS_PER_PAGE) + i + 1;
                
                if (pageIndex === 0 && i >= WHOLESALER_SUMMARY_START_ROW && rowData.isSummaryRow) {
                    row.className = 'wholesaler-summary-row';
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td colspan="4">${rowData.fishName || 'পাইকারি সারাংশ'}</td>
                        <td>${formatNumber(rowData.calculatedAmount)}</td>
                        <td>${rowData.wholesalerName || ''}</td>
                        <td>${formatNumber(rowData.calculatedWholesaleTotal)}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td><input type="text" class="input-cell fish-name" value="${rowData.fishName || ''}"></td>
                        <td><input type="number" class="input-cell maund-rate" value="${rowData.maundRate || ''}" min="0" max="999999" placeholder=""></td>
                        <td class="rate ${rowData.calculatedRate ? '' : 'empty-cell'}">${rowData.calculatedRate ? formatNumber(rowData.calculatedRate) : ''}</td>
                        <td><input type="number" class="input-cell kg" value="${rowData.kg || ''}" step="0.01" placeholder=""></td>
                        <td class="amount ${rowData.calculatedAmount ? '' : 'empty-cell'}">${rowData.calculatedAmount ? formatNumber(rowData.calculatedAmount) : ''}</td>
                        <td><input type="text" class="input-cell wholesaler-name" value="${rowData.wholesalerName || ''}" data-serial="${rowNumber}" placeholder=""></td>
                        <td class="wholesale-total ${rowData.calculatedWholesaleTotal ? '' : 'empty-cell'}">${rowData.calculatedWholesaleTotal ? formatNumber(rowData.calculatedWholesaleTotal) : ''}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.maund-rate, .kg').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        calculateRow(this.closest('tr'));
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                    });
                }
            });
            
            document.querySelectorAll('.wholesaler-name').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                    });
                }
            });
            
            document.querySelectorAll('.fish-name').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        checkForTotalRow(this.closest('tr'));
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                    });
                }
            });
            
            updatePageTotals();
        }
        
        function updateWholesalerSummary() {
            if (pages.length === 0) return;
            
            const firstPage = pages[0];
            const wholesalersList = Object.keys(allWholesalers).filter(name => name && allWholesalers[name].totalAmount > 0);
            
            for (let i = WHOLESALER_SUMMARY_START_ROW; i < ROWS_PER_PAGE; i++) {
                firstPage.rows[i] = {
                    fishName: '',
                    maundRate: '',
                    kg: '',
                    wholesalerName: '',
                    calculatedRate: 0,
                    calculatedAmount: 0,
                    calculatedWholesaleTotal: 0,
                    isSummaryRow: false
                };
            }
            
            wholesalersList.forEach((name, index) => {
                const rowIndex = WHOLESALER_SUMMARY_START_ROW + index;
                if (rowIndex >= ROWS_PER_PAGE) return;
                
                const wholesalerData = allWholesalers[name];
                const wholesaleTotal = wholesalerData.totalAmount * WHOLESALER_RATE;
                
                firstPage.rows[rowIndex] = {
                    fishName: 'পাইকারি সারাংশ',
                    maundRate: '',
                    kg: '',
                    wholesalerName: name,
                    calculatedRate: 0,
                    calculatedAmount: wholesalerData.totalAmount,
                    calculatedWholesaleTotal: wholesaleTotal,
                    isSummaryRow: true
                };
            });
            
            if (currentPageIndex === 0) {
                renderPage(0);
            }
        }
        
        function savePageData() {
            const page = pages[currentPageIndex];
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach((row, i) => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                page.rows[i] = {
                    fishName: row.querySelector('.fish-name')?.value || '',
                    maundRate: row.querySelector('.maund-rate')?.value || '',
                    kg: row.querySelector('.kg')?.value || '',
                    wholesalerName: row.querySelector('.wholesaler-name')?.value || '',
                    calculatedRate: parseFloat(row.querySelector('.rate')?.textContent) || 0,
                    calculatedAmount: parseFloat(row.querySelector('.amount')?.textContent) || 0,
                    calculatedWholesaleTotal: parseFloat(row.querySelector('.wholesale-total')?.textContent) || 0,
                    isSummaryRow: false
                };
            });
        }
        
        function prevPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                renderPage(currentPageIndex);
                updatePageTabs();
            }
        }
        
        function nextPage() {
            if (currentPageIndex < pages.length - 1) {
                currentPageIndex++;
                renderPage(currentPageIndex);
                updatePageTabs();
            }
        }
        
        function formatNumber(value) {
            if (value === 0 || isNaN(value) || value === '') return '';
            return parseFloat(value).toFixed(2);
        }
        
        function calculateRow(row) {
            if (row.classList.contains('wholesaler-summary-row')) return;
            
            const maundRate = parseFloat(row.querySelector('.maund-rate').value) || 0;
            const kg = parseFloat(row.querySelector('.kg').value) || 0;
            
            const rate = maundRate / 40;
            const amount = rate * kg;
            
            const rateCell = row.querySelector('.rate');
            const amountCell = row.querySelector('.amount');
            
            if (maundRate > 0 && kg > 0) {
                rateCell.textContent = formatNumber(rate) || '';
                rateCell.classList.remove('empty-cell');
                amountCell.textContent = formatNumber(amount) || '';
                amountCell.classList.remove('empty-cell');
            } else {
                rateCell.textContent = '';
                rateCell.classList.add('empty-cell');
                amountCell.textContent = '';
                amountCell.classList.add('empty-cell');
            }
        }
        
        function updateAllWholesalers() {
            allWholesalers = {};
            
            pages.forEach((page, pageIndex) => {
                page.rows.forEach((row, rowIndex) => {
                    if (row.isSummaryRow) return;
                    
                    const wholesalerName = row.wholesalerName.trim();
                    const amount = row.calculatedAmount || 0;
                    
                    if (wholesalerName) {
                        if (!allWholesalers[wholesalerName]) {
                            allWholesalers[wholesalerName] = {
                                totalAmount: 0,
                                firstOccurrence: {
                                    pageIndex: pageIndex,
                                    rowIndex: rowIndex
                                }
                            };
                        }
                        allWholesalers[wholesalerName].totalAmount += amount;
                    }
                });
            });
            
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const wholesaleTotalCell = row.querySelector('.wholesale-total');
                if (wholesaleTotalCell) {
                    wholesaleTotalCell.textContent = '';
                    wholesaleTotalCell.classList.add('empty-cell');
                }
                row.classList.remove('first-occurrence');
            });
            
            const seenWholesalers = new Set();
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const wholesalerName = row.querySelector('.wholesaler-name')?.value.trim();
                
                if (wholesalerName && !seenWholesalers.has(wholesalerName)) {
                    seenWholesalers.add(wholesalerName);
                    const wholesalerData = allWholesalers[wholesalerName];
                    if (wholesalerData) {
                        const totalAmount = wholesalerData.totalAmount || 0;
                        const wholesaleTotal = totalAmount * WHOLESALER_RATE;
                        const wholesaleTotalCell = row.querySelector('.wholesale-total');
                        
                        if (wholesaleTotal > 0 && wholesaleTotalCell) {
                            wholesaleTotalCell.textContent = formatNumber(wholesaleTotal) || '';
                            wholesaleTotalCell.classList.remove('empty-cell');
                            row.classList.add('first-occurrence');
                        }
                    }
                }
            });
            
            updateGrandTotals();
        }
        
        function updatePageTotals() {
            const rows = document.querySelectorAll('#tableBody tr');
            let totalKg = 0;
            let totalTk = 0;
            let totalWholesale = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const kg = parseFloat(row.querySelector('.kg')?.value) || 0;
                const amount = parseFloat(row.querySelector('.amount')?.textContent) || 0;
                const wholesaleTotal = parseFloat(row.querySelector('.wholesale-total')?.textContent) || 0;
                
                if (kg > 0) totalKg += kg;
                if (amount > 0) totalTk += amount;
                if (wholesaleTotal > 0) totalWholesale += wholesaleTotal;
            });
            
            document.getElementById('totalKg').textContent = formatNumber(totalKg) || '0';
            document.getElementById('totalTk').textContent = formatNumber(totalTk) || '0';
            document.getElementById('sumTk').textContent = formatNumber(totalTk) || '0';
            document.getElementById('totalWholesale').textContent = formatNumber(totalWholesale) || '0';
        }
        
        function updateGrandTotals() {
            let grandTotalKg = 0;
            let grandTotalTk = 0;
            let grandTotalWholesale = 0;
            
            pages.forEach(page => {
                page.rows.forEach(row => {
                    if (row.isSummaryRow) return;
                    
                    const kg = parseFloat(row.kg) || 0;
                    const amount = row.calculatedAmount || 0;
                    
                    if (kg > 0) grandTotalKg += kg;
                    if (amount > 0) grandTotalTk += amount;
                });
            });
            
            for (const [name, data] of Object.entries(allWholesalers)) {
                if (data.totalAmount > 0) {
                    grandTotalWholesale += data.totalAmount * WHOLESALER_RATE;
                }
            }
            
            document.getElementById('grandTotalKg').textContent = formatNumber(grandTotalKg) || '0';
            document.getElementById('grandSumTk').textContent = formatNumber(grandTotalTk) || '0';
            document.getElementById('grandTotalWholesale').textContent = formatNumber(grandTotalWholesale) || '0';
        }
        
        function checkForTotalRow(row) {
            if (row.classList.contains('wholesaler-summary-row')) return;
            
            const fishNameInput = row.querySelector('.fish-name');
            const fishName = fishNameInput.value.trim().toLowerCase();
            
            if (fishName === 'মোট' || fishName === 'total') {
                row.classList.add('total-row-highlight');
                
                let totalKg = 0;
                let totalAmount = 0;
                let totalWholesale = 0;
                let currentRow = row.previousElementSibling;
                
                while (currentRow) {
                    if (currentRow.classList.contains('wholesaler-summary-row')) {
                        currentRow = currentRow.previousElementSibling;
                        continue;
                    }
                    
                    const kg = parseFloat(currentRow.querySelector('.kg')?.value) || 0;
                    const amount = parseFloat(currentRow.querySelector('.amount')?.textContent) || 0;
                    const isFirstOccurrence = currentRow.classList.contains('first-occurrence');
                    
                    if (kg > 0) totalKg += kg;
                    if (amount > 0) totalAmount += amount;
                    
                    if (isFirstOccurrence) {
                        const wholesaleAmount = parseFloat(currentRow.querySelector('.wholesale-total')?.textContent) || 0;
                        if (wholesaleAmount > 0) totalWholesale += wholesaleAmount;
                    }
                    
                    currentRow = currentRow.previousElementSibling;
                }
                
                row.querySelector('.maund-rate').value = '';
                row.querySelector('.kg').value = totalKg > 0 ? formatNumber(totalKg) : '';
                
                const rateCell = row.querySelector('.rate');
                rateCell.textContent = '';
                rateCell.classList.add('empty-cell');
                
                const amountCell = row.querySelector('.amount');
                amountCell.textContent = totalAmount > 0 ? formatNumber(totalAmount) : '';
                if (totalAmount > 0) amountCell.classList.remove('empty-cell');
                else amountCell.classList.add('empty-cell');
                
                row.querySelector('.wholesaler-name').value = 'মোট';
                
                const wholesaleTotalCell = row.querySelector('.wholesale-total');
                wholesaleTotalCell.textContent = totalWholesale > 0 ? formatNumber(totalWholesale) : '';
                if (totalWholesale > 0) wholesaleTotalCell.classList.remove('empty-cell');
                else wholesaleTotalCell.classList.add('empty-cell');
                
                row.querySelector('.maund-rate').disabled = true;
                row.querySelector('.kg').disabled = true;
                row.querySelector('.wholesaler-name').disabled = true;
            } else {
                row.classList.remove('total-row-highlight');
                row.querySelector('.maund-rate').disabled = false;
                row.querySelector('.kg').disabled = false;
                row.querySelector('.wholesaler-name').disabled = false;
            }
        }
        
        function zoomIn() {
            if (currentZoom < 150) {
                currentZoom += 10;
                document.getElementById('tableContainer').style.transform = `scale(${currentZoom/100})`;
                document.getElementById('tableContainer').style.transformOrigin = 'top left';
            }
        }
        
        function zoomOut() {
            if (currentZoom > 70) {
                currentZoom -= 10;
                document.getElementById('tableContainer').style.transform = `scale(${currentZoom/100})`;
                document.getElementById('tableContainer').style.transformOrigin = 'top left';
            }
        }
    </script>
</body>
</html>
