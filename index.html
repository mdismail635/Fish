<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>মাছের দর হিসাব</title>
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="manifest.json">
    <style>
        
        /* মোবাইল ডিসপ্লে অপ্টিমাইজেশন - কালার ও স্টাইল আপডেট */
@media (max-width: 768px) {
    body {
        padding: 3px;
        font-size: 14px;
        overflow-x: hidden;
        background-color: #f8f9fa;
    }
    
    .header {
        flex-direction: column;
        gap: 5px;
        font-size: 14px;
        background-color: #4CAF50;
        color: white;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    
    .underline {
        border-bottom: 2px solid white;
        color: white;
        padding-bottom: 2px;
    }
    
    .table-container {
        width: 100vw;
        margin-left: -5px;
        margin-right: -5px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    table {
        min-width: 800px;
        overflow-x: auto;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    th {
        background-color: #2E7D32;
        color: white;
        position: sticky;
        top: 0;
        font-weight: 600;
        padding: 8px 3px;
    }
    
    td {
        background-color: white;
    }
    
    tr:nth-child(even) td {
        background-color: #f1f8e9;
    }
    
    .page-controls, .backup-controls {
        flex-direction: column;
        align-items: center;
        gap: 5px;
        background-color: #e8f5e9;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .page-btn, .backup-btn, .zoom-btn {
        padding: 8px 12px;
        font-size: 12px;
        width: 100%;
        max-width: 180px;
        font-weight: bold;
        transition: all 0.3s;
    }
    
    .page-btn {
        background-color: #4CAF50;
    }
    
    .backup-btn {
        background-color: #2196F3;
    }
    
    .zoom-btn {
        background-color: #FF9800;
    }
    
    .page-btn:hover, .backup-btn:hover, .zoom-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    .page-tabs {
        justify-content: center;
        overflow-x: auto;
        padding-bottom: 5px;
        background-color: #e8f5e9;
        padding: 8px;
        border-radius: 8px;
    }
    
    .page-tab {
        padding: 5px 10px;
        font-size: 12px;
        background-color: #c8e6c9;
        color: #2E7D32;
    }
    
    .page-tab.active {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
    }
    
    /* কলাম প্রস্থ সামঞ্জস্য */
    .serial { width: 15px; }
    .fish-name { width: 40px; }
    .maund-rate { width: 50px; }
    .rate { width: 40px; }
    .kg { width: 40px; }
    .amount { width: 60px; }
    .wholesaler { width: 70px; }
    .wholesale-total { width: 70px; }
    
    /* ইনপুট ফিল্ড স্টাইল */
    .input-cell {
        padding: 5px;
        font-size: 12px;
        border: 1px solid #bdbdbd;
        border-radius: 4px;
        background-color: white;
    }
    
    .input-cell:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    /* জুম কন্ট্রোল */
    .zoom-controls {
        position: fixed;
        bottom: 20px;
        right: 15px;
        z-index: 100;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .zoom-btn {
        width: 50px;
        height: 50px;
        padding: 0;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* টোটাল রো স্টাইল */
    .total-row {
        background-color: #bbdefb !important;
        color: #0d47a1;
    }
    
    .sum-cell {
        background-color: #ffecb3;
        color: #ff6f00;
        font-weight: bold;
    }
    
    .wholesaler-summary-row {
        background-color: #e8f5e9 !important;
        color: #2E7D32;
    }
    
    .first-occurrence {
        background-color: #fffde7;
    }
    
    .confirmation {
        background-color: #4CAF50;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .install-btn {
        background-color: #FF9800;
        font-weight: bold;
    }
}

/* অতিরিক্ত ছোট ডিভাইসের জন্য (320px-480px) */
@media (max-width: 480px) {
    body {
        font-size: 13px;
    }
    
    th, td {
        padding: 5px 2px;
    }
    
    .page-btn, .backup-btn {
        max-width: 160px;
        padding: 7px 10px;
    }
    
    .input-cell {
        padding: 4px;
        font-size: 11px;
    }
    
    .zoom-btn {
        width: 45px;
        height: 45px;
        font-size: 16px;
    }
}

/* সবচেয়ে ছোট ডিভাইসের জন্য (320px পর্যন্ত) */
@media (max-width: 320px) {
    body {
        font-size: 12px;
    }
    
    .page-btn, .backup-btn {
        max-width: 140px;
        padding: 6px 8px;
        font-size: 11px;
    }
    
    .input-cell {
        font-size: 10px;
    }
}    

        
    </style>
</head>
<body>
    <div class="confirmation" id="confirmation"></div>
    
    <button id="installButton" class="install-btn" onclick="installPWA()">অ্যাপ ইন্সটল করুন</button>
    
    <div class="header">
        <div>পার্টি নাম: <span class="underline" id="partyName" contenteditable="true">&nbsp;</span></div>
        <div>তারিখ: <span class="underline" id="dateField" contenteditable="true">&nbsp;</span></div>
    </div>

    <div class="page-tabs" id="pageTabs"></div>

    <div class="page-controls">
    <button class="page-btn" onclick="addNewPage()">নতুন পেজ (+)</button>
    <div class="page-info">পেজ: <span id="currentPage">1</span></div>
    <div>
        <button class="page-btn" onclick="prevPage()">পূর্ববর্তী</button>
        <button class="page-btn" onclick="nextPage()">পরবর্তী</button>
        <button class="page-btn" onclick="confirmDeleteCurrentPage()" style="background-color: #f44336;">পেজ ডিলেট</button>
        <button class="page-btn" onclick="confirmResetAllData()" style="background-color: #ff9800;">সব ডাটা রিসেট</button>
    </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">জুম আউট (-)</button>
        <button class="zoom-btn" onclick="zoomIn()">জুম ইন (+)</button>
    </div>

    <div class="table-container" id="tableContainer">
        <table id="fishTable">
            <thead>
                <tr>
                    <th class="serial">ক্রমিক</th>
                    <th class="fish-name">মাছের নাম</th>
                    <th class="maund-rate">মন দর</th>
                    <th class="rate">দর</th>
                    <th class="kg">কেজি</th>
                    <th class="amount">টাকা</th>
                    <th class="wholesaler">পাইকার নাম</th>
                    <th class="wholesale-total">পাইকার মোট</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- রোসমূহ স্বয়ংক্রিয়ভাবে যুক্ত হবে -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="5" style="text-align: right;">মোট টাকা =</td>
                    <td id="totalTk" class="sum-cell">0</td>
                    <td colspan="2"></td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">পেজ মোট</td>
                    <td id="totalKg">0</td>
                    <td id="sumTk">0</td>
                    <td colspan="2" id="totalWholesale" class="sum-cell">0</td>
                </tr>
                <tr class="total-row">
                    <td colspan="4">সর্বমোট (সকল পেজ)</td>
                    <td id="grandTotalKg">0</td>
                    <td id="grandSumTk">0</td>
                    <td colspan="2" id="grandTotalWholesale" class="sum-cell">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="backup-controls">
        <button class="backup-btn" onclick="backupData()">ডেটা সেভ করুন</button>
        <button class="backup-btn" onclick="restoreData()">ডেটা রিস্টোর করুন</button>
        <button class="backup-btn" onclick="exportData()">ডেটা ডাউনলোড করুন</button>
        <button class="backup-btn" onclick="importData()">ডেটা আপলোড করুন</button>
        <button class="backup-btn" onclick="signInWithGoogle()">গুগল ড্রাইভে সেভ করুন</button>
        <button class="backup-btn" onclick="loadFromGoogleDrive()">গুগল ড্রাইভ থেকে লোড করুন</button>
    </div>

    <script>
        // অ্যাপ্লিকেশন স্টেট
        let currentZoom = 100;
        const WHOLESALER_RATE = 1.03; // সব পাইকারের জন্য 3% যোগ
        let pages = [];
        let currentPageIndex = 0;
        const ROWS_PER_PAGE = 60;
        let currentDate = '';
        let allWholesalers = {};
        const WHOLESALER_SUMMARY_START_ROW = 0;
        let deferredPrompt = null;
        
        // ডাটা স্টোরেজ কী
        const STORAGE_KEY = 'fish_calculator_data_v4';
        
        // ডাটা সেভ করার ফাংশন
        function backupData() {
            const data = {
                pages: pages,
                currentPageIndex: currentPageIndex,
                currentDate: currentDate,
                allWholesalers: allWholesalers,
                partyName: document.getElementById('partyName').textContent.trim(),
                dateField: document.getElementById('dateField').textContent.trim()
            };
            
            // লোকাল স্টোরেজে সেভ করুন
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            // ইন্ডেক্সড ডিবি তেও সেভ করুন (অফলাইন ব্যবহারের জন্য)
            if ('indexedDB' in window) {
                saveToIndexedDB(data);
            }
            
            showConfirmation('ডেটা সফলভাবে সেভ করা হয়েছে!');
        }
        
        // ইন্ডেক্সড ডিবি তে ডাটা সেভ
        function saveToIndexedDB(data) {
            const request = indexedDB.open('FishCalculatorDB', 1);
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('calculatorData')) {
                    db.createObjectStore('calculatorData', { keyPath: 'id' });
                }
            };
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['calculatorData'], 'readwrite');
                const store = transaction.objectStore('calculatorData');
                
                store.put({ id: 1, data: data });
            };
        }
        
        // ডাটা রিস্টোর করার ফাংশন
        function restoreData() {
            // প্রথমে লোকাল স্টোরেজ থেকে চেষ্টা করুন
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    restoreBackupData(data);
                    return;
                } catch (e) {
                    console.error('লোকাল স্টোরেজ ডাটা পার্স করতে সমস্যা:', e);
                }
            }
            
            // যদি লোকাল স্টোরেজে না থাকে, ইন্ডেক্সড ডিবি থেকে চেষ্টা করুন
            if ('indexedDB' in window) {
                loadFromIndexedDB();
            } else {
                showConfirmation('কোন সেভ করা ডেটা পাওয়া যায়নি!');
                initializeNewData();
            }
        }
        
        // ইন্ডেক্সড ডিবি থেকে ডাটা লোড
        function loadFromIndexedDB() {
            const request = indexedDB.open('FishCalculatorDB', 1);
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                const transaction = db.transaction(['calculatorData'], 'readonly');
                const store = transaction.objectStore('calculatorData');
                const getRequest = store.get(1);
                
                getRequest.onsuccess = function() {
                    if (getRequest.result) {
                        restoreBackupData(getRequest.result.data);
                    } else {
                        showConfirmation('কোন সেভ করা ডেটা পাওয়া যায়নি!');
                        initializeNewData();
                    }
                };
                
                getRequest.onerror = function() {
                    showConfirmation('ডেটা লোড করতে সমস্যা হয়েছে!');
                    initializeNewData();
                };
            };
            
            request.onerror = function() {
                showConfirmation('ডাটাবেস অ্যাক্সেস করতে সমস্যা হয়েছে!');
                initializeNewData();
            };
        }
        
        // ডাটা রিস্টোর করুন
        function restoreBackupData(data) {
            pages = data.pages || [];
            currentPageIndex = data.currentPageIndex || 0;
            currentDate = data.currentDate || '';
            allWholesalers = data.allWholesalers || {};
            
            if (data.partyName) {
                document.getElementById('partyName').textContent = data.partyName;
            }
            
            if (data.dateField) {
                document.getElementById('dateField').textContent = data.dateField;
            } else {
                const today = new Date();
                currentDate = today.getDate() + '/' + (today.getMonth()+1) + '/' + today.getFullYear();
                document.getElementById('dateField').textContent = currentDate;
            }
            
            if (pages.length === 0) {
                addNewPage();
            } else {
                renderPage(currentPageIndex);
                updatePageTabs();
            }
            
            showConfirmation('ডেটা সফলভাবে রিস্টোর করা হয়েছে!');
        }
        
        // নতুন ডাটা ইনিশিয়ালাইজ করুন
        function initializeNewData() {
            const today = new Date();
            currentDate = today.getDate() + '/' + (today.getMonth()+1) + '/' + today.getFullYear();
            document.getElementById('dateField').textContent = currentDate;
            
            addNewPage();
        }
        
        // কনফার্মেশন মেসেজ দেখান
        function showConfirmation(message) {
            const confirmation = document.getElementById('confirmation');
            confirmation.textContent = message;
            confirmation.style.display = 'block';
            setTimeout(() => {
                confirmation.style.display = 'none';
            }, 3000);
        }
        
        // নতুন পেজ যোগ করুন
        function addNewPage() {
            const newPage = {
                rows: [],
                partyName: '',
                date: currentDate
            };
            
            for (let i = 1; i <= ROWS_PER_PAGE; i++) {
                newPage.rows.push({
                    fishName: '',
                    maundRate: '',
                    kg: '',
                    wholesalerName: '',
                    calculatedRate: 0,
                    calculatedAmount: 0,
                    calculatedWholesaleTotal: 0,
                    isSummaryRow: false
                });
            }
            
            pages.push(newPage);
            currentPageIndex = pages.length - 1;
            updatePageTabs();
            renderPage(currentPageIndex);
            updateAllWholesalers();
            updateWholesalerSummary();
            
            // অটো সেভ
            backupData();
        }
        
        // পেজ ট্যাব আপডেট করুন
        function updatePageTabs() {
            const pageTabs = document.getElementById('pageTabs');
            pageTabs.innerHTML = '';
            
            pages.forEach((page, index) => {
                const tab = document.createElement('div');
                tab.className = `page-tab ${index === currentPageIndex ? 'active' : ''}`;
                tab.textContent = `পেজ ${index + 1}`;
                tab.onclick = () => {
                    currentPageIndex = index;
                    renderPage(currentPageIndex);
                    updatePageTabs();
                };
                pageTabs.appendChild(tab);
            });
        }
        
        // বর্তমান পেজ রেন্ডার করুন
        function renderPage(pageIndex) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const page = pages[pageIndex];
            document.getElementById('currentPage').textContent = pageIndex + 1;
            
            page.rows.forEach((rowData, i) => {
                const row = document.createElement('tr');
                const rowNumber = (pageIndex * ROWS_PER_PAGE) + i + 1;
                
                if (pageIndex === 0 && i >= WHOLESALER_SUMMARY_START_ROW && rowData.isSummaryRow) {
                    row.className = 'wholesaler-summary-row';
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td colspan="4">${rowData.fishName || 'পাইকারি সারাংশ'}</td>
                        <td>${formatNumber(rowData.calculatedAmount)}</td>
                        <td>${rowData.wholesalerName || ''}</td>
                        <td>${formatNumber(rowData.calculatedWholesaleTotal)}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td><input type="text" class="input-cell fish-name" value="${rowData.fishName || ''}"></td>
                        <td><input type="number" class="input-cell maund-rate" value="${rowData.maundRate || ''}" min="0" max="999999" placeholder=""></td>
                        <td class="rate ${rowData.calculatedRate ? '' : 'empty-cell'}">${rowData.calculatedRate ? formatNumber(rowData.calculatedRate) : ''}</td>
                        <td><input type="number" class="input-cell kg" value="${rowData.kg || ''}" step="0.01" placeholder=""></td>
                        <td class="amount ${rowData.calculatedAmount ? '' : 'empty-cell'}">${rowData.calculatedAmount ? formatNumber(rowData.calculatedAmount) : ''}</td>
                        <td><input type="text" class="input-cell wholesaler-name" value="${rowData.wholesalerName || ''}" data-serial="${rowNumber}" placeholder=""></td>
                        <td class="wholesale-total ${rowData.calculatedWholesaleTotal ? '' : 'empty-cell'}">${rowData.calculatedWholesaleTotal ? formatNumber(rowData.calculatedWholesaleTotal) : ''}</td>
                    `;
                }
                
                tableBody.appendChild(row);
            });
            
            // ইভেন্ট লিসেনার যোগ করুন
            addEventListeners();
            
            // ক্যালকুলেশন আপডেট করুন
            updatePageTotals();
        }
        
        // ইভেন্ট লিসেনার যোগ করুন
        function addEventListeners() {
            document.querySelectorAll('.maund-rate, .kg').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        calculateRow(this.closest('tr'));
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                        backupData(); // প্রতিটি পরিবর্তনে অটো সেভ
                    });
                }
            });
            
            document.querySelectorAll('.wholesaler-name').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                        backupData(); // প্রতিটি পরিবর্তনে অটো সেভ
                    });
                }
            });
            
            document.querySelectorAll('.fish-name').forEach(input => {
                if (!input.closest('tr').classList.contains('wholesaler-summary-row')) {
                    input.addEventListener('input', function() {
                        checkForTotalRow(this.closest('tr'));
                        savePageData();
                        updateAllWholesalers();
                        updatePageTotals();
                        updateWholesalerSummary();
                        backupData(); // প্রতিটি পরিবর্তনে অটো সেভ
                    });
                }
            });
            
            document.getElementById('partyName').addEventListener('input', backupData);
            document.getElementById('dateField').addEventListener('input', backupData);
        }
        
        // বর্তমান পেজের ডাটা সেভ করুন
        function savePageData() {
            const page = pages[currentPageIndex];
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach((row, i) => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                page.rows[i] = {
                    fishName: row.querySelector('.fish-name')?.value || '',
                    maundRate: row.querySelector('.maund-rate')?.value || '',
                    kg: row.querySelector('.kg')?.value || '',
                    wholesalerName: row.querySelector('.wholesaler-name')?.value || '',
                    calculatedRate: parseFloat(row.querySelector('.rate')?.textContent) || 0,
                    calculatedAmount: parseFloat(row.querySelector('.amount')?.textContent) || 0,
                    calculatedWholesaleTotal: parseFloat(row.querySelector('.wholesale-total')?.textContent) || 0,
                    isSummaryRow: false
                };
            });
        }
        
        // পূর্ববর্তী পেজে যান
        function prevPage() {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                renderPage(currentPageIndex);
                updatePageTabs();
            }
        }
        
        // পরবর্তী পেজে যান
        function nextPage() {
            if (currentPageIndex < pages.length - 1) {
                currentPageIndex++;
                renderPage(currentPageIndex);
                updatePageTabs();
            }
        }
        
        // সংখ্যা ফরম্যাট করুন
        function formatNumber(value) {
            if (value === 0 || isNaN(value) || value === '') return '';
            return parseFloat(value).toFixed(2);
        }

        // বর্তমান পেজ ডিলেট করার কনফার্মেশন
function confirmDeleteCurrentPage() {
    if (pages.length <= 1) {
        showConfirmation('অন্তত একটি পেজ থাকা আবশ্যক!');
        return;
    }

    if (confirm('আপনি কি নিশ্চিত যে আপনি বর্তমান পেজ ডিলেট করতে চান? এই কাজটি পূর্বাবস্থায় ফেরানো যাবে না!')) {
        deleteCurrentPage();
    }
}

// বর্তমান পেজ ডিলেট করুন
function deleteCurrentPage() {
    pages.splice(currentPageIndex, 1);
    
    // যদি শেষ পেজ ডিলেট করা হয়, তাহলে পূর্ববর্তী পেজে যান
    if (currentPageIndex >= pages.length) {
        currentPageIndex = pages.length - 1;
    }
    
    renderPage(currentPageIndex);
    updatePageTabs();
    updateAllWholesalers();
    updateWholesalerSummary();
    backupData();
    
    showConfirmation('পেজ সফলভাবে ডিলেট করা হয়েছে!');
}

// সব ডাটা রিসেট করার কনফার্মেশন
function confirmResetAllData() {
    if (confirm('আপনি কি নিশ্চিত যে আপনি সব ডাটা রিসেট করতে চান?\n\nএই কাজটি পূর্বাবস্থায় ফেরানো যাবে না!\nসমস্ত পেজ এবং তথ্য মুছে ফেলা হবে!')) {
        resetAllData();
    }
}

// সব ডাটা রিসেট করুন
function resetAllData() {
    // লোকাল স্টোরেজ এবং ইন্ডেক্সড ডিবি থেকে ডাটা মুছুন
    localStorage.removeItem(STORAGE_KEY);
    
    if ('indexedDB' in window) {
        const request = indexedDB.deleteDatabase('FishCalculatorDB');
        request.onsuccess = function() {
            console.log('Database successfully deleted');
        };
        request.onerror = function() {
            console.log('Error deleting database');
        };
    }
    
    // নতুন ডাটা দিয়ে ইনিশিয়ালাইজ করুন
    pages = [];
    allWholesalers = {};
    currentPageIndex = 0;
    
    document.getElementById('partyName').textContent = '';
    
    const today = new Date();
    currentDate = today.getDate() + '/' + (today.getMonth()+1) + '/' + today.getFullYear();
    document.getElementById('dateField').textContent = currentDate;
    
    addNewPage();
    
    showConfirmation('সব ডাটা সফলভাবে রিসেট করা হয়েছে!');
     }
        // সারি ক্যালকুলেশন করুন
        function calculateRow(row) {
            if (row.classList.contains('wholesaler-summary-row')) return;
            
            const maundRate = parseFloat(row.querySelector('.maund-rate').value) || 0;
            const kg = parseFloat(row.querySelector('.kg').value) || 0;
            
            const rate = maundRate / 40;
            const amount = rate * kg;
            
            const rateCell = row.querySelector('.rate');
            const amountCell = row.querySelector('.amount');
            
            if (maundRate > 0 && kg > 0) {
                rateCell.textContent = formatNumber(rate) || '';
                rateCell.classList.remove('empty-cell');
                amountCell.textContent = formatNumber(amount) || '';
                amountCell.classList.remove('empty-cell');
            } else {
                rateCell.textContent = '';
                rateCell.classList.add('empty-cell');
                amountCell.textContent = '';
                amountCell.classList.add('empty-cell');
            }
        }
        
        // পাইকারদের তথ্য আপডেট করুন
        function updateAllWholesalers() {
            allWholesalers = {};
            
            pages.forEach((page, pageIndex) => {
                page.rows.forEach((row, rowIndex) => {
                    if (row.isSummaryRow) return;
                    
                    const wholesalerName = row.wholesalerName.trim();
                    const amount = row.calculatedAmount || 0;
                    
                    if (wholesalerName) {
                        if (!allWholesalers[wholesalerName]) {
                            allWholesalers[wholesalerName] = {
                                totalAmount: 0,
                                firstOccurrence: {
                                    pageIndex: pageIndex,
                                    rowIndex: rowIndex
                                }
                            };
                        }
                        allWholesalers[wholesalerName].totalAmount += amount;
                    }
                });
            });
            
            const rows = document.querySelectorAll('#tableBody tr');
            
            // প্রথমে সব হোলসেল টোটাল রিসেট করুন
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const wholesaleTotalCell = row.querySelector('.wholesale-total');
                if (wholesaleTotalCell) {
                    wholesaleTotalCell.textContent = '';
                    wholesaleTotalCell.classList.add('empty-cell');
                }
                row.classList.remove('first-occurrence');
            });
            
            // প্রথম অকারেন্সের জন্য টোটাল সেট করুন
            const seenWholesalers = new Set();
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const wholesalerName = row.querySelector('.wholesaler-name')?.value.trim();
                
                if (wholesalerName && !seenWholesalers.has(wholesalerName)) {
                    seenWholesalers.add(wholesalerName);
                    const wholesalerData = allWholesalers[wholesalerName];
                    if (wholesalerData) {
                        const totalAmount = wholesalerData.totalAmount || 0;
                        const wholesaleTotal = totalAmount * WHOLESALER_RATE;
                        const wholesaleTotalCell = row.querySelector('.wholesale-total');
                        
                        if (wholesaleTotal > 0 && wholesaleTotalCell) {
                            wholesaleTotalCell.textContent = formatNumber(wholesaleTotal) || '';
                            wholesaleTotalCell.classList.remove('empty-cell');
                            row.classList.add('first-occurrence');
                        }
                    }
                }
            });
            
            updateGrandTotals();
        }
        
        // পাইকারি সারাংশ আপডেট করুন
        function updateWholesalerSummary() {
            if (pages.length === 0) return;
            
            const firstPage = pages[0];
            const wholesalersList = Object.keys(allWholesalers).filter(name => name && allWholesalers[name].totalAmount > 0);
            
            for (let i = WHOLESALER_SUMMARY_START_ROW; i < ROWS_PER_PAGE; i++) {
                firstPage.rows[i] = {
                    fishName: '',
                    maundRate: '',
                    kg: '',
                    wholesalerName: '',
                    calculatedRate: 0,
                    calculatedAmount: 0,
                    calculatedWholesaleTotal: 0,
                    isSummaryRow: false
                };
            }
            
            wholesalersList.forEach((name, index) => {
                const rowIndex = WHOLESALER_SUMMARY_START_ROW + index;
                if (rowIndex >= ROWS_PER_PAGE) return;
                
                const wholesalerData = allWholesalers[name];
                const wholesaleTotal = wholesalerData.totalAmount * WHOLESALER_RATE;
                
                firstPage.rows[rowIndex] = {
                    fishName: 'পাইকারি সারাংশ',
                    maundRate: '',
                    kg: '',
                    wholesalerName: name,
                    calculatedRate: 0,
                    calculatedAmount: wholesalerData.totalAmount,
                    calculatedWholesaleTotal: wholesaleTotal,
                    isSummaryRow: true
                };
            });
            
            if (currentPageIndex === 0) {
                renderPage(0);
            }
        }
        
        // পেজ টোটাল আপডেট করুন
        function updatePageTotals() {
            const rows = document.querySelectorAll('#tableBody tr');
            let totalKg = 0;
            let totalTk = 0;
            let totalWholesale = 0;
            
            rows.forEach(row => {
                if (row.classList.contains('wholesaler-summary-row')) return;
                
                const kg = parseFloat(row.querySelector('.kg')?.value) || 0;
                const amount = parseFloat(row.querySelector('.amount')?.textContent) || 0;
                const wholesaleTotal = parseFloat(row.querySelector('.wholesale-total')?.textContent) || 0;
                
                if (kg > 0) totalKg += kg;
                if (amount > 0) totalTk += amount;
                if (wholesaleTotal > 0) totalWholesale += wholesaleTotal;
            });
            
            document.getElementById('totalKg').textContent = formatNumber(totalKg) || '0';
            document.getElementById('totalTk').textContent = formatNumber(totalTk) || '0';
            document.getElementById('sumTk').textContent = formatNumber(totalTk) || '0';
            document.getElementById('totalWholesale').textContent = formatNumber(totalWholesale) || '0';
        }
        
        // গ্র্যান্ড টোটাল আপডেট করুন
        function updateGrandTotals() {
            let grandTotalKg = 0;
            let grandTotalTk = 0;
            let grandTotalWholesale = 0;
            
            pages.forEach(page => {
                page.rows.forEach(row => {
                    if (row.isSummaryRow) return;
                    
                    const kg = parseFloat(row.kg) || 0;
                    const amount = row.calculatedAmount || 0;
                    
                    if (kg > 0) grandTotalKg += kg;
                    if (amount > 0) grandTotalTk += amount;
                });
            });
            
            for (const [name, data] of Object.entries(allWholesalers)) {
                if (data.totalAmount > 0) {
                    grandTotalWholesale += data.totalAmount * WHOLESALER_RATE;
                }
            }
            
            document.getElementById('grandTotalKg').textContent = formatNumber(grandTotalKg) || '0';
            document.getElementById('grandSumTk').textContent = formatNumber(grandTotalTk) || '0';
            document.getElementById('grandTotalWholesale').textContent = formatNumber(grandTotalWholesale) || '0';
        }
        
        // টোটাল সারি চেক করুন
        function checkForTotalRow(row) {
            if (row.classList.contains('wholesaler-summary-row')) return;
            
            const fishNameInput = row.querySelector('.fish-name');
            const fishName = fishNameInput.value.trim().toLowerCase();
            
            if (fishName === 'মোট' || fishName === 'total') {
                row.classList.add('total-row-highlight');
                
                let totalKg = 0;
                let totalAmount = 0;
                let totalWholesale = 0;
                let currentRow = row.previousElementSibling;
                
                while (currentRow) {
                    if (currentRow.classList.contains('wholesaler-summary-row')) {
                        currentRow = currentRow.previousElementSibling;
                        continue;
                    }
                    
                    const kg = parseFloat(currentRow.querySelector('.kg')?.value) || 0;
                    const amount = parseFloat(currentRow.querySelector('.amount')?.textContent) || 0;
                    const isFirstOccurrence = currentRow.classList.contains('first-occurrence');
                    
                    if (kg > 0) totalKg += kg;
                    if (amount > 0) totalAmount += amount;
                    
                    if (isFirstOccurrence) {
                        const wholesaleAmount = parseFloat(currentRow.querySelector('.wholesale-total')?.textContent) || 0;
                        if (wholesaleAmount > 0) totalWholesale += wholesaleAmount;
                    }
                    
                    currentRow = currentRow.previousElementSibling;
                }
                
                row.querySelector('.maund-rate').value = '';
                row.querySelector('.kg').value = totalKg > 0 ? formatNumber(totalKg) : '';
                
                const rateCell = row.querySelector('.rate');
                rateCell.textContent = '';
                rateCell.classList.add('empty-cell');
                
                const amountCell = row.querySelector('.amount');
                amountCell.textContent = totalAmount > 0 ? formatNumber(totalAmount) : '';
                if (totalAmount > 0) amountCell.classList.remove('empty-cell');
                else amountCell.classList.add('empty-cell');
                
                row.querySelector('.wholesaler-name').value = 'মোট';
                
                const wholesaleTotalCell = row.querySelector('.wholesale-total');
                wholesaleTotalCell.textContent = totalWholesale > 0 ? formatNumber(totalWholesale) : '';
                if (totalWholesale > 0) wholesaleTotalCell.classList.remove('empty-cell');
                else wholesaleTotalCell.classList.add('empty-cell');
                
                row.querySelector('.maund-rate').disabled = true;
                row.querySelector('.kg').disabled = true;
                row.querySelector('.wholesaler-name').disabled = true;
            } else {
                row.classList.remove('total-row-highlight');
                row.querySelector('.maund-rate').disabled = false;
                row.querySelector('.kg').disabled = false;
                row.querySelector('.wholesaler-name').disabled = false;
            }
        }
        
        // জুম ইন করুন
        function zoomIn() {
            if (currentZoom < 150) {
                currentZoom += 10;
                document.getElementById('tableContainer').style.transform = `scale(${currentZoom/100})`;
                document.getElementById('tableContainer').style.transformOrigin = 'top left';
            }
        }
        
        // জুম আউট করুন
        function zoomOut() {
            if (currentZoom > 70) {
                currentZoom -= 10;
                document.getElementById('tableContainer').style.transform = `scale(${currentZoom/100})`;
                document.getElementById('tableContainer').style.transformOrigin = 'top left';
            }
        }
        
        // ডেটা এক্সপোর্ট করুন
        function exportData() {
            const data = {
                pages: pages,
                currentPageIndex: currentPageIndex,
                currentDate: currentDate,
                allWholesalers: allWholesalers,
                partyName: document.getElementById('partyName').textContent.trim(),
                dateField: document.getElementById('dateField').textContent.trim()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fish_calculator_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showConfirmation('ডেটা সফলভাবে ডাউনলোড করা হয়েছে!');
        }
        
        // ডেটা ইম্পোর্ট করুন
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('আপনি কি নিশ্চিত যে আপনি বর্তমান ডেটা প্রতিস্থাপন করতে চান? এটি বর্তমান ডেটা মুছে ফেলবে!')) {
                            restoreBackupData(data);
                            backupData(); // নতুন ডাটা সেভ করুন
                        }
                    } catch (e) {
                        showConfirmation('ফাইল পড়তে সমস্যা হয়েছে! সঠিক ফরম্যাট নয়।');
                        console.error(e);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // গুগল ড্রাইভ ইন্টিগ্রেশন
        function initGoogleClient() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: 'AIzaSyBUUxEsQCdz2ACBZvb2m5uR-P6OdhfoYAs',
                    clientId: '716394900797-snmc10jkgi23p57pd7405i94et5i8ks5.apps.googleusercontent.com',
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                    scope: 'https://www.googleapis.com/auth/drive.file'
                }).then(() => {
                    console.log('Google API client initialized');
                }, (error) => {
                    console.error('Error initializing Google API client', error);
                });
            });
        }
        
        // গুগল API লোড করুন
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                initGoogleClient();
            };
            document.body.appendChild(script);
        }
        
        // গুগলে সাইন ইন করুন
        function signInWithGoogle() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                showConfirmation('গুগলে সাইন ইন সফল হয়েছে!');
                uploadToGoogleDrive();
            }).catch(error => {
                showConfirmation('সাইন ইন করতে সমস্যা হয়েছে: ' + error.error);
            });
        }
        
        // গুগল ড্রাইভে আপলোড করুন
        function uploadToGoogleDrive() {
            const data = {
                pages: pages,
                currentPageIndex: currentPageIndex,
                currentDate: currentDate,
                allWholesalers: allWholesalers,
                partyName: document.getElementById('partyName').textContent.trim(),
                dateField: document.getElementById('dateField').textContent.trim()
            };
            
            const date = new Date().toISOString().split('T')[0];
            const fileName = `fish_calculator_${date}.json`;
            
            const fileContent = JSON.stringify(data, null, 2);
            const file = new Blob([fileContent], {type: 'application/json'});
            const metadata = {
                'name': fileName,
                'mimeType': 'application/json'
            };
            
            const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            }).then((response) => {
                return response.json();
            }).then((data) => {
                showConfirmation('গুগল ড্রাইভে সফলভাবে সেভ করা হয়েছে!');
                console.log('File uploaded:', data);
            }).catch((error) => {
                showConfirmation('আপলোড করতে সমস্যা হয়েছে: ' + error.message);
                console.error('Upload error:', error);
            });
        }
        
        // গুগল ড্রাইভ থেকে লোড করুন
        function loadFromGoogleDrive() {
            gapi.auth2.getAuthInstance().signIn().then(() => {
                gapi.client.drive.files.list({
                    'pageSize': 10,
                    'fields': "files(id, name)",
                    'q': "name contains 'fish_calculator' and mimeType='application/json'",
                    'orderBy': 'modifiedTime desc'
                }).then((response) => {
                    const files = response.result.files;
                    if (files.length === 0) {
                        showConfirmation('কোন ফাইল পাওয়া যায়নি!');
                        return;
                    }
                    
                    const fileId = files[0].id;
                    downloadFromGoogleDrive(fileId);
                });
            }).catch(error => {
                showConfirmation('সাইন ইন করতে সমস্যা হয়েছে: ' + error.error);
            });
        }
        
        // গুগল ড্রাইভ থেকে ডাউনলোড করুন
        function downloadFromGoogleDrive(fileId) {
            gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            }).then((response) => {
                if (confirm('আপনি কি নিশ্চিত যে আপনি বর্তমান ডেটা প্রতিস্থাপন করতে চান? এটি বর্তমান ডেটা মুছে ফেলবে!')) {
                    restoreBackupData(response.result);
                    backupData(); // নতুন ডাটা লোকালেও সেভ করুন
                    showConfirmation('গুগল ড্রাইভ থেকে ডেটা সফলভাবে লোড করা হয়েছে!');
                }
            }).catch((error) => {
                showConfirmation('ডেটা লোড করতে সমস্যা হয়েছে: ' + error.message);
                console.error('Download error:', error);
            });
        }
        
        // PWA ইন্সটলেশন
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installButton').style.display = 'block';
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showConfirmation('অ্যাপ ইন্সটল করা হচ্ছে...');
                    }
                    deferredPrompt = null;
                    document.getElementById('installButton').style.display = 'none';
                });
            }
        }
        
        // অ্যাপ্লিকেশন ইনিশিয়ালাইজেশন
        document.addEventListener('DOMContentLoaded', function() {
            // গুগল API লোড করুন
            loadGoogleAPI();
            
            // ডাটা রিস্টোর করুন
            restoreData();
            
            // অটো সেভ ইন্টারভাল সেট করুন (প্রতি 30 সেকেন্ডে)
            setInterval(backupData, 30000);
            
            // পেজ আনলোড হওয়ার আগে ডাটা সেভ করুন
            window.addEventListener('beforeunload', function(e) {
                backupData();
            });
        });
    </script>
</body>
</html>
